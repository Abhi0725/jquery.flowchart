$(function(){$.widget("flowchart.flowchart",{options:{canUserEditLinks:!0,canUserMoveOperators:!0,data:{},distanceFromArrow:3,defaultOperatorClass:"flowchart-default-operator",defaultLinkColor:"#3366ff",defaultSelectedLinkColor:"black",linkWidth:11,grid:20,multipleLinksOnOutput:!1,multipleLinksOnInput:!1,onOperatorSelect:function(t){return!0},onOperatorUnselect:function(){return!0},onLinkSelect:function(t){return!0},onLinkUnselect:function(){return!0},onOperatorCreate:function(t,e,o){return!0},onLinkCreate:function(t,e){return!0},onOperatorDelete:function(t){return!0},onLinkDelete:function(t,e){return!0}},data:{operators:{},links:{}},objs:{layers:{operators:null,temporaryLink:null,links:null},linksContext:null,temporaryLink:null},maskNum:0,linkNum:0,lastOutputConnectorClicked:null,selectedOperatorId:null,selectedLinkId:null,positionRatio:1,_create:function(){this.element.addClass("flowchart-container"),this.objs.layers.links=$('<svg class="flowchart-links-layer"></svg>'),this.objs.layers.links.appendTo(this.element),this.objs.layers.operators=$('<div class="flowchart-operators-layer unselectable"></div>'),this.objs.layers.operators.appendTo(this.element),this.objs.layers.temporaryLink=$('<svg class="flowchart-temporary-link-layer"></svg>'),this.objs.layers.temporaryLink.appendTo(this.element);var t=document.createElementNS("http://www.w3.org/2000/svg","line");t.setAttribute("x1","0"),t.setAttribute("y1","0"),t.setAttribute("x2","0"),t.setAttribute("y2","0"),t.setAttribute("stroke-dasharray","6,6"),t.setAttribute("stroke-width","4"),t.setAttribute("stroke","black"),t.setAttribute("fill","none"),this.objs.layers.temporaryLink[0].appendChild(t),this.objs.temporaryLink=t,this._initEvents(),"undefined"!=typeof this.options.data&&this.setData(this.options.data)},_initEvents:function(){var t=this;this.element.mousemove(function(e){var o=$(this),r=o.offset();t._mousemove((e.pageX-r.left)/t.positionRatio,(e.pageY-r.top)/t.positionRatio,e)}),this.element.click(function(e){var o=$(this),r=o.offset();t._click((e.pageX-r.left)/t.positionRatio,(e.pageY-r.top)/t.positionRatio,e)}),this.objs.layers.operators.on("mousedown touchstart",".flowchart-operator",function(t){t.stopImmediatePropagation()}),this.objs.layers.operators.on("click",".flowchart-operator",function(e){0==$(e.target).closest(".flowchart-operator-connector").length&&t.selectOperator($(this).data("operator_id"))}),this.objs.layers.operators.on("click",".flowchart-operator-connector",function(){var e=$(this);t.options.canUserEditLinks&&t._connectorClicked(e.closest(".flowchart-operator").data("operator_id"),e.data("connector"),e.data("connector_type"))}),this.objs.layers.links.on("mousedown touchstart",".flowchart-link",function(t){t.stopImmediatePropagation()}),this.objs.layers.links.on("mouseover",".flowchart-link",function(){t._connecterMouseOver($(this).data("link_id"))}),this.objs.layers.links.on("mouseout",".flowchart-link",function(){t._connecterMouseOut($(this).data("link_id"))}),this.objs.layers.links.on("click",".flowchart-link",function(){t.selectLink($(this).data("link_id"))})},setData:function(t){this._clearOperatorsLayer(),this.data.operators={};for(var e in t.operators)this.createOperator(e,t.operators[e]);for(var o in t.links)this.createLink(o,t.links[o]);this.redrawLinksLayer()},addLink:function(t){for(;"undefined"!=typeof this.data.links[this.linkNum];)this.linkNum++;return this.createLink(this.linkNum,t),this.linkNum},createLink:function(t,e){var o=$.extend(!0,{},e);if(this.options.onLinkCreate(t,o)){var r=this.options.multipleLinksOnOutput,i=this.options.multipleLinksOnInput;if(!r||!i)for(var n in this.data.links){var s=this.data.links[n];r||s.from_operator!=o.from_operator||s.from_connector!=o.from_connector?i||s.to_operator!=o.to_operator||s.to_connector!=o.to_connector||this.deleteLink(n):this.deleteLink(n)}this.data.links[t]=o,this._drawLink(t)}},redrawLinksLayer:function(){this._clearLinksLayer();for(var t in this.data.links)this._drawLink(t)},_clearLinksLayer:function(){this.objs.layers.links.empty(),this.objs.layers.operators.find(".flowchart-operator-connector-small-arrow").css("border-left-color","transparent")},_clearOperatorsLayer:function(){this.objs.layers.operators.empty()},getConnectorPosition:function(t,e){var o=this.data.operators[t],r=o.internal.els.connectorArrows[e],i=r.offset(),n=this.element.offset(),s=(i.left-n.left)/this.positionRatio,a=parseInt(r.css("border-top-width")),l=(i.top-n.top)/this.positionRatio+parseInt(r.css("border-left-width"));return{x:s,width:a,y:l}},getLinkMainColor:function(t){var e=this.options.defaultLinkColor,o=this.data.links[t];return"undefined"!=typeof o.color&&(e=o.color),e},setLinkMainColor:function(t,e){this.data.links[t].color=e},_drawLink:function(t){var e=this.data.links[t];"undefined"==typeof e.internal&&(e.internal={}),e.internal.els={};var o=e.from_operator,r=e.from_connector,i=e.to_operator,n=e.to_connector,a=(this.getLinkMainColor(t),this.data.operators[o]),l=this.data.operators[i],p=a.internal.els.connectorSmallArrows[r],c=l.internal.els.connectorSmallArrows[n];e.internal.els.fromSmallConnector=p,e.internal.els.toSmallConnector=c;var u=document.createElementNS("http://www.w3.org/2000/svg","g");this.objs.layers.links[0].appendChild(u),e.internal.els.overallGroup=u;var d=document.createElementNS("http://www.w3.org/2000/svg","mask"),h="fc_mask_"+this.maskNum;this.maskNum++,d.setAttribute("id",h),u.appendChild(d);var f=document.createElementNS("http://www.w3.org/2000/svg","rect");f.setAttribute("x","0"),f.setAttribute("y","0"),f.setAttribute("width","100%"),f.setAttribute("height","100%"),f.setAttribute("stroke","none"),f.setAttribute("fill","white"),d.appendChild(f);var f=document.createElementNS("http://www.w3.org/2000/svg","polygon");f.setAttribute("stroke","none"),f.setAttribute("fill","black"),d.appendChild(f),e.internal.els.mask=f;var k=document.createElementNS("http://www.w3.org/2000/svg","g");k.setAttribute("class","flowchart-link"),k.setAttribute("data-link_id",t),u.appendChild(k);var f=document.createElementNS("http://www.w3.org/2000/svg","path");f.setAttribute("stroke-width",this.options.linkWidth),f.setAttribute("fill","none"),k.appendChild(f),e.internal.els.path=f;var f=document.createElementNS("http://www.w3.org/2000/svg","rect");f.setAttribute("stroke","none"),f.setAttribute("mask","url(#"+h+")"),k.appendChild(f),e.internal.els.rect=f,this._refreshLinkPositions(t),this.uncolorizeLink(t)},_refreshLinkPositions:function(t){var e=this.data.links[t],o=this.getConnectorPosition(e.from_operator,e.from_connector),r=this.getConnectorPosition(e.to_operator,e.to_connector),i=o.x,n=o.width,s=o.y,a=r.x,l=r.y,p=this.options.distanceFromArrow;e.internal.els.mask.setAttribute("points",i+","+(s-n-p)+" "+(i+n+p)+","+s+" "+i+","+(s+n+p));var c=i+n+p,u=a+1,d=Math.min(100,Math.max(Math.abs(c-u)/2,Math.abs(s-l)));e.internal.els.path.setAttribute("d","M"+c+","+s+" C"+(i+n+p+d)+","+s+" "+(a-d)+","+l+" "+u+","+l),e.internal.els.rect.setAttribute("x",i),e.internal.els.rect.setAttribute("y",s-this.options.linkWidth/2),e.internal.els.rect.setAttribute("width",n+p+1),e.internal.els.rect.setAttribute("height",this.options.linkWidth)},getOperatorCompleteData:function(t){infos=$.extend(!0,{},t.properties);for(var e in infos.inputs)null==infos.inputs[e]&&delete infos.inputs[e];for(var e in infos.outputs)null==infos.outputs[e]&&delete infos.outputs[e];return"undefined"==typeof infos["class"]&&(infos["class"]=this.options.defaultOperatorClass),infos},_getOperatorFullElement:function(t){function c(t,e,o,r){var i=$('<div class="flowchart-operator-connector"></div>');i.appendTo(o),i.data("connector",t),i.data("connector_type",r);var n=$('<div class="flowchart-operator-connector-label"></div>');n.text(e.label),n.appendTo(i);var s=$('<div class="flowchart-operator-connector-arrow"></div>');s.appendTo(i);var a=$('<div class="flowchart-operator-connector-small-arrow"></div>');a.appendTo(i),l[t]=s,p[t]=a}var e=this.getOperatorCompleteData(t),o=$('<div class="flowchart-operator"></div>');o.addClass(e["class"]);var r=$('<div class="flowchart-operator-title"></div>');r.text(e.title),r.appendTo(o);var i=$('<div class="flowchart-operator-inputs-outputs"></div>');i.appendTo(o);var n=$('<div class="flowchart-operator-inputs"></div>');n.appendTo(i);var s=$('<div class="flowchart-operator-outputs"></div>');s.appendTo(i);var l={},p={};for(var u in e.inputs)c(u,e.inputs[u],n,"inputs");for(var u in e.outputs)c(u,e.outputs[u],s,"outputs");return{operator:o,title:r,connectorArrows:l,connectorSmallArrows:p}},getOperatorElement:function(t){var e=this._getOperatorFullElement(t);return e.operator},createOperator:function(t,e){function n(t,o){e.top=o.top,e.left=o.left;for(var r in i.data.links){var n=i.data.links[r];(n.from_operator==t||n.to_operator==t)&&i._refreshLinkPositions(r)}}var o=this._getOperatorFullElement(e);if(!this.options.onOperatorCreate(t,e,o))return!1;var r=this.options.grid;e.top=Math.round(e.top/r)*r,e.left=Math.round(e.left/r)*r,o.operator.appendTo(this.objs.layers.operators),o.operator.css({top:e.top,left:e.left}),o.operator.data("operator_id",t),this.data.operators[t]=e,this.data.operators[t].internal={},this.data.operators[t].internal.els=o,t==this.selectedOperatorId&&this._addSelectedClass(t);var e=this.data.operators[t],i=this;if(this.options.canUserMoveOperators){var s,a;o.operator.draggable({start:function(t,e){if(null!=i.lastOutputConnectorClicked)return void t.preventDefault();var o=i.element.offset();s=(t.pageX-o.left)/i.positionRatio-parseInt($(t.target).css("left")),a=(t.pageY-o.top)/i.positionRatio-parseInt($(t.target).css("top"))},drag:function(t,e){var r=i.options.grid,l=i.element.offset();e.position.left=Math.round(((t.pageX-l.left)/i.positionRatio-s)/r)*r,e.position.top=Math.round(((t.pageY-l.top)/i.positionRatio-a)/r)*r,e.offset.left=Math.round(e.position.left+l.left),e.offset.top=Math.round(e.position.top+l.top),o.operator.css({left:e.position.left,top:e.position.top}),n($(this).data("operator_id"),e.position)},stop:function(t,e){if(e.position.top!=e.originalPosition.top||e.position.left!=e.originalPosition.left){var r=new Date;o.operator.data("lastDragDropStopTime",r.getTime())}i._unsetTemporaryLink(),n($(this).data("operator_id"),e.position)}})}},_connectorClicked:function(t,e,o){if("outputs"==o){var r=this.data.operators[t].internal.els.operator.data("lastDragDropStopTime"),i=new Date;i.getTime();if("undefined"==typeof r||i>r+50){this.lastOutputConnectorClicked={operator:t,connector:e},this.objs.layers.temporaryLink.show();var s=this.getConnectorPosition(t,e),a=s.x+s.width,l=s.y;this.objs.temporaryLink.setAttribute("x1",a),this.objs.temporaryLink.setAttribute("y1",l),this._mousemove(a,l)}}if("inputs"==o&&null!=this.lastOutputConnectorClicked){var p={from_operator:this.lastOutputConnectorClicked.operator,from_connector:this.lastOutputConnectorClicked.connector,to_operator:t,to_connector:e};this.addLink(p),this._unsetTemporaryLink()}},_unsetTemporaryLink:function(){this.lastOutputConnectorClicked=null,this.objs.layers.temporaryLink.hide()},_mousemove:function(t,e,o){null!=this.lastOutputConnectorClicked&&(this.objs.temporaryLink.setAttribute("x2",t),this.objs.temporaryLink.setAttribute("y2",e))},_click:function(t,e,o){var r=$(o.target);0==r.closest(".flowchart-operator-connector").length&&this._unsetTemporaryLink(),0==r.closest(".flowchart-operator").length&&this.unselectOperator(),0==r.closest(".flowchart-link").length&&this.unselectLink()},_removeSelectedClassOperators:function(){this.objs.layers.operators.find(".flowchart-operator").removeClass("selected")},unselectOperator:function(){this.options.onOperatorUnselect()&&(this._removeSelectedClassOperators(),this.selectedOperatorId=null)},_addSelectedClass:function(t){this.data.operators[t].internal.els.operator.addClass("selected")},selectOperator:function(t){this.options.onOperatorSelect(t)&&(this.unselectLink(),this._removeSelectedClassOperators(),this._addSelectedClass(t),this.selectedOperatorId=t)},getSelectedOperatorId:function(){return this.selectedOperatorId},getSelectedLinkId:function(){return this.selectedLinkId},_shadeColor:function(t,e){var o=parseInt(t.slice(1),16),r=0>e?0:255,i=0>e?-1*e:e,n=o>>16,s=o>>8&255,a=255&o;return"#"+(16777216+65536*(Math.round((r-n)*i)+n)+256*(Math.round((r-s)*i)+s)+(Math.round((r-a)*i)+a)).toString(16).slice(1)},colorizeLink:function(t,e){var o=this.data.links[t];o.internal.els.path.setAttribute("stroke",e),o.internal.els.rect.setAttribute("fill",e),o.internal.els.fromSmallConnector.css("border-left-color",e),o.internal.els.toSmallConnector.css("border-left-color",e)},uncolorizeLink:function(t){this.colorizeLink(t,this.getLinkMainColor(t))},_connecterMouseOver:function(t){this.selectedLinkId!=t&&this.colorizeLink(t,this._shadeColor(this.getLinkMainColor(t),-.4))},_connecterMouseOut:function(t){this.selectedLinkId!=t&&this.uncolorizeLink(t)},unselectLink:function(){if(null!=this.selectedLinkId){if(!this.options.onLinkUnselect())return;this.uncolorizeLink(this.selectedLinkId,this.options.defaultSelectedLinkColor),this.selectedLinkId=null}},selectLink:function(t){this.unselectLink(),this.options.onLinkSelect(t)&&(this.unselectOperator(),this.selectedLinkId=t,this.colorizeLink(t,this.options.defaultSelectedLinkColor))},deleteOperator:function(t){this._deleteOperator(t,!1)},_deleteOperator:function(t,e){if(!this.options.onOperatorDelete(t,e))return!1;if(!e)for(var o in this.data.links){var r=this.data.links[o];(r.from_operator==t||r.to_operator==t)&&this._deleteLink(o,!0)}e||t!=this.selectedOperatorId||this.unselectOperator(),this.data.operators[t].internal.els.operator.remove(),delete this.data.operators[t]},deleteLink:function(t){this._deleteLink(t,!1)},_deleteLink:function(t,e){(this.options.onLinkDelete(t,e)||e)&&(this.selectedLinkId==t&&(this.selectedLinkId=null),this.colorizeLink(t,"transparent"),this.data.links[t].internal.els.overallGroup.remove(),delete this.data.links[t])},deleteSelected:function(){null!=this.selectedLinkId&&this.deleteLink(this.selectedLinkId),null!=this.selectedOperatorId&&this.deleteOperator(this.selectedOperatorId)},setPositionRatio:function(t){this.positionRatio=t},getPositionRatio:function(){return this.positionRatio},getData:function(){var t=["operators","links"],e=$.extend(!0,{},this.data);for(var o in t){var r=t[o];for(var i in e[r])delete e[r][i].internal}return e},setOperatorTitle:function(t,e){this.data.operators[t].internal.els.title.text(e),"undefined"==typeof this.data.operators[t].properties&&(this.data.operators[t].properties={}),this.data.operators[t].properties.title=e},getOperatorTitle:function(t){return this.data.operators[t].properties.title},setOperatorData:function(t,e){var o=this.getOperatorCompleteData(e);for(var r in this.data.links){var i=this.data.links[r];console.log(i,i.from_operator==r,"undefined"==typeof o.outputs[i.from_connector]),(i.from_operator==t&&"undefined"==typeof o.outputs[i.from_connector]||i.to_operator==t&&"undefined"==typeof o.inputs[i.to_connector])&&this._deleteLink(r,!0)}this._deleteOperator(t,!0),this.createOperator(t,e),this.redrawLinksLayer()},getOperatorData:function(t){var e=$.extend(!0,{},this.data.operators[t]);return delete e.internal,e}})});